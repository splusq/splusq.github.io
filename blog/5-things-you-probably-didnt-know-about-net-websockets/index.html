<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>5 things you probably didn't know about .NET WebSockets | Salman Quazi</title>
<meta name=keywords content="Uncategorized"><meta name=description content="As most of you probably already know WebSocket provides full-duplex communication over a single TCP connection. .NET 4.5 added support for WebSockets as part of the BCL. In this article I am going to talk about few of the subtleties that you need to think about.
Connection upgrade is somewhat expensive WebSocket connections are initiated as traditional HTTP connections. The client then usually requests an &ldquo;upgrade&rdquo; to a WebSocket session, this upgrade process is relatively expensive."><meta name=author content><link rel=canonical href=https://www.salmanq.com/blog/5-things-you-probably-didnt-know-about-net-websockets/><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://www.salmanq.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.salmanq.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.salmanq.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.salmanq.com/apple-touch-icon.png><link rel=mask-icon href=https://www.salmanq.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-38742121-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="5 things you probably didn't know about .NET WebSockets"><meta property="og:description" content="As most of you probably already know WebSocket provides full-duplex communication over a single TCP connection. .NET 4.5 added support for WebSockets as part of the BCL. In this article I am going to talk about few of the subtleties that you need to think about.
Connection upgrade is somewhat expensive WebSocket connections are initiated as traditional HTTP connections. The client then usually requests an &ldquo;upgrade&rdquo; to a WebSocket session, this upgrade process is relatively expensive."><meta property="og:type" content="article"><meta property="og:url" content="https://www.salmanq.com/blog/5-things-you-probably-didnt-know-about-net-websockets/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2013-04-13T23:45:28+00:00"><meta property="article:modified_time" content="2013-04-13T23:45:28+00:00"><meta property="og:site_name" content="Salman Quazi"><meta name=twitter:card content="summary"><meta name=twitter:title content="5 things you probably didn't know about .NET WebSockets"><meta name=twitter:description content="As most of you probably already know WebSocket provides full-duplex communication over a single TCP connection. .NET 4.5 added support for WebSockets as part of the BCL. In this article I am going to talk about few of the subtleties that you need to think about.
Connection upgrade is somewhat expensive WebSocket connections are initiated as traditional HTTP connections. The client then usually requests an &ldquo;upgrade&rdquo; to a WebSocket session, this upgrade process is relatively expensive."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blogs","item":"https://www.salmanq.com/blog/"},{"@type":"ListItem","position":2,"name":"5 things you probably didn't know about .NET WebSockets","item":"https://www.salmanq.com/blog/5-things-you-probably-didnt-know-about-net-websockets/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"5 things you probably didn't know about .NET WebSockets","name":"5 things you probably didn\u0027t know about .NET WebSockets","description":"As most of you probably already know WebSocket provides full-duplex communication over a single TCP connection. .NET 4.5 added support for WebSockets as part of the BCL. In this article I am going to talk about few of the subtleties that you need to think about.\nConnection upgrade is somewhat expensive WebSocket connections are initiated as traditional HTTP connections. The client then usually requests an \u0026ldquo;upgrade\u0026rdquo; to a WebSocket session, this upgrade process is relatively expensive.","keywords":["Uncategorized"],"articleBody":" As most of you probably already know WebSocket provides full-duplex communication over a single TCP connection. .NET 4.5 added support for WebSockets as part of the BCL. In this article I am going to talk about few of the subtleties that you need to think about.\nConnection upgrade is somewhat expensive WebSocket connections are initiated as traditional HTTP connections. The client then usually requests an “upgrade” to a WebSocket session, this upgrade process is relatively expensive. If you are interested in performance you may want to pool a set of connection that are already upgraded and use connections from the pool.\nSimultaneous sends or receives While you can simultaneously do send and receive, you can only do one of each simultaneously. In other words at any given point in time you can only have a single pending send or a single pending receive. Various workaround exists for this limitation. For instance, SignalR uses a queue. The other option is to provide synchronizations using a ManualResetEvent - there are pros and cons to both so you need to think about what makes sense for your specific application.\nTeardown There are two ways to close a WebSocket connection. The graceful way is CloseAsync which when initiated sends a message to the connected party, and waits for acknowledgement. The keyword here is sends. Remember in our previous point we discussed that you can only have a single send or receive at any given point in time? So if you are sending data, and at the same time try to CloseAsync this leads to an exception because CloseAsync will also try to send a message. The other option is to use CloseOutputAsync this is more of a “fire-and-forget” approach.\nCOM Exceptions? Based on some of our testing there are certain COM level exceptions that can happen during high load conditions. Once again if you look at the SignalR implementation you can treat these types of exceptions as non-fatal. 0x800703e3 - The I/O operation has been aborted because of either a thread exit or application request 0x800704cd - The remote host closed the connection 0x80070026 - Reached the end-of-file\nUnobserved Exceptions Any unobserved exceptions (background thread exceptions that weren’t caught) can cause your WebSocket to get into an aborted state. This is because the .NET 4.5 implementation of WebSocket adds a TaskScheulder.UnobservedExceptions handler and aborts the connection for any exceptions that propagate up to it. So you have couple of choices here, first make sure that you don’t have unobserved exceptions (which means you have an issue that you are not even aware of). If you call any method that initiates a Task - make sure you store it and add a continuation to observe it’s exceptions. The other option is to add a TaskScheduler.UnobservedExceptions yourself to see what potential exceptions you are missing.\n","wordCount":"469","inLanguage":"en","datePublished":"2013-04-13T23:45:28Z","dateModified":"2013-04-13T23:45:28Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.salmanq.com/blog/5-things-you-probably-didnt-know-about-net-websockets/"},"publisher":{"@type":"Organization","name":"Salman Quazi","logo":{"@type":"ImageObject","url":"https://www.salmanq.com/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.salmanq.com/ accesskey=h title="Salman Quazi (Alt + H)">Salman Quazi</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.salmanq.com/blog/ title=Blog><span>Blog</span></a></li><li><a href=https://github.com/splusq/ title=Github><span>Github</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://www.linkedin.com/in/salmanquazi/ title=LinkedIn><span>LinkedIn</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://www.twitter.com/splusq title=Twitter><span>Twitter</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>5 things you probably didn't know about .NET WebSockets</h1><div class=post-meta>&lt;span title='2013-04-13 23:45:28 +0000 UTC'>April 13, 2013&lt;/span>&amp;nbsp;·&amp;nbsp;3 min</div></header><div class=post-content><p><img loading=lazy src=/2013/04/websockets.png alt=WebSockets>
As most of you probably already know WebSocket provides full-duplex communication over a single TCP connection. .NET 4.5 added support for WebSockets as part of the BCL. In this article I am going to talk about few of the subtleties that you need to think about.</p><ol><li><p><strong>Connection upgrade is somewhat expensive</strong> WebSocket connections are initiated as traditional HTTP connections. The client then usually requests an &ldquo;upgrade&rdquo; to a WebSocket session, this upgrade process is relatively expensive. If you are interested in performance you may want to pool a set of connection that are already upgraded and use connections from the pool.</p></li><li><p><strong>Simultaneous sends or receives</strong> While you can simultaneously do send and receive, you can only do one of each simultaneously. In other words at any given point in time you can only have a single pending send or a single pending receive. Various workaround exists for this limitation. For instance, <a href=https://github.com/SignalR/SignalR/blob/master/src/Microsoft.AspNet.SignalR.Owin45/WebSockets/WebSocketHandler.cs>SignalR</a> uses a queue. The other option is to provide synchronizations using a ManualResetEvent - there are pros and cons to both so you need to think about what makes sense for your specific application.</p></li><li><p><strong>Teardown</strong> There are two ways to close a WebSocket connection. The graceful way is <a href=http://msdn.microsoft.com/en-us/library/system.net.websockets.websocket.closeasync.aspx>CloseAsync</a> which when initiated <strong>sends a message</strong> to the connected party, and waits for acknowledgement. The keyword here is <em>sends</em>. Remember in our previous point we discussed that you can only have a single send or receive at any given point in time? So if you are sending data, and at the same time try to CloseAsync this leads to an exception because CloseAsync will <em>also</em> try to send a message. The other option is to use <a href=http://msdn.microsoft.com/en-us/library/system.net.websockets.websocket.closeoutputasync.aspx>CloseOutputAsync</a> this is more of a &ldquo;fire-and-forget&rdquo; approach.</p></li><li><p><strong>COM Exceptions?</strong> Based on some of our testing there are certain COM level exceptions that can happen during high load conditions. Once again if you look at the <a href=https://github.com/SignalR/SignalR/blob/master/src/Microsoft.AspNet.SignalR.Owin45/WebSockets/WebSocketHandler.cs>SignalR implementation</a> you can treat these types of exceptions as non-fatal. 0x800703e3 - The I/O operation has been aborted because of either a thread exit or application request 0x800704cd - The remote host closed the connection 0x80070026 - Reached the end-of-file</p></li><li><p><strong>Unobserved Exceptions</strong> Any unobserved exceptions (background thread exceptions that weren&rsquo;t caught) can cause your WebSocket to get into an aborted state. This is because the .NET 4.5 implementation of WebSocket adds a <a href=http://msdn.microsoft.com/en-us/library/system.threading.tasks.taskscheduler.unobservedtaskexception.aspx>TaskScheulder.UnobservedExceptions</a> handler and aborts the connection for any exceptions that propagate up to it. So you have couple of choices here, first make sure that you don&rsquo;t have unobserved exceptions (which means you have an issue that you are not even aware of). If you call any method that initiates a Task - make sure you store it and add a continuation to observe it&rsquo;s exceptions. The other option is to add a TaskScheduler.UnobservedExceptions yourself to see what potential exceptions you are missing.</p></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.salmanq.com/tags/uncategorized/>Uncategorized</a></li></ul><nav class=paginav><a class=prev href=https://www.salmanq.com/blog/switched-to-hugo-from-wordpress/><span class=title>« Prev</span><br><span>Switched to Hugo from Wordpress</span>
</a><a class=next href=https://www.salmanq.com/blog/building-a-service-execution-pipeline/><span class=title>Next »</span><br><span>Building a service execution pipeline</span></a></nav></footer><script src=https://utteranc.es/client.js repo=splusq/splusq.github.io issue-term=title theme=github-dark crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2023 <a href=https://www.salmanq.com/>Salman Quazi</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>