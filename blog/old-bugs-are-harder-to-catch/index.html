<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.120.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>Old bugs are harder to catch &#183; Salman Quazi</title>
<meta name=description content><link type=text/css rel=stylesheet href=https://www.salmanq.com/css/print.css media=print><link type=text/css rel=stylesheet href=https://www.salmanq.com/css/poole.css><link type=text/css rel=stylesheet href=https://www.salmanq.com/css/syntax.css><link type=text/css rel=stylesheet href=https://www.salmanq.com/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png><style type=text/css>.sidebar-about h1{font-size:1.95rem;font-weight:400}</style><script async src="https://www.googletagmanager.com/gtag/js?id=G-K4WVH5P91F"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-K4WVH5P91F")</script></head><body class=theme-base-08><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://www.salmanq.com/><h1>Salman Quazi</h1></a><p class=lead>Engineering Manager for Microsoft Azure Cognitive Services in Mountain View, CA.</p></div><nav><ul class=sidebar-nav><li><a href=https://www.salmanq.com/>Home</a></li><li><a href=/blog/>Blog</a></li><li><a href=https://github.com/splusq/>Github</a></li><li><a href=https://www.linkedin.com/in/salmanquazi/>LinkedIn</a></li><li><a href=https://www.twitter.com/splusq>Twitter</a></li></ul></nav><p>Opinions are my own.</p></div></aside><main class="content container"><div class=post><h1>Old bugs are harder to catch</h1><time datetime=2005-04-20T03:18:49Z class=post-date>Wed, Apr 20, 2005</time><p>About three years ago I worked on an application that in-part had to blend in with several other applications. Among many features one of them was to automatically generate something known as deadlines. The actual details are far to complicated to explain in details here, so I will use a simpler example.</p><p>Assume that you have four types of documents each have their own specific way of computing deadline. One of them follows a rule like:</p><ol><li>The deadline for document A is the fourth work day of the month
unless the fifth of the month is a Friday and that friday is a workday.2. If however the month for which we are computing the deadline for is August then the deadline is 3rd Friday unless it&rsquo;s happens to be a holiday; in that case then it&rsquo;s the first available workday since the 3rd Friday of the month.</li></ol><p>As you can see the rule is not straight forward and involves several fine details that if programmed incorrectly will cause other systems to fail, since it feeds data to them. One such bug caused this app to fail yesterday and finally we found what the problem was. In order to see the bug I will first present to you a pseudo-code of the intial program:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span> <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>FifthIsFriday</span>(<span style=color:#a6e22e>CurrentMonth</span>, <span style=color:#a6e22e>CurrentYear</span>)) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>CurrentMonth</span>.<span style=color:#a6e22e>GetMonth</span>() <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;AUG&#34;</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Deadline</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>FindFourthWorkDay</span>(<span style=color:#a6e22e>CurrentMonth</span>, <span style=color:#a6e22e>CurrentYear</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Deadline</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ThirdFriday</span>(<span style=color:#a6e22e>CurrentMonth</span>, <span style=color:#a6e22e>CurrentYear</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>IsHoliday</span>(<span style=color:#a6e22e>Deadline</span>)) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Deadline</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>FindNextWorkDay</span>(<span style=color:#a6e22e>Deadline</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span> { <span style=color:#75715e>// Fifth is a friday
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>IsHoliday</span>(<span style=color:#a6e22e>DateValue</span>(<span style=color:#a6e22e>CurrentMonth</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#39;/&#39;</span><span style=color:#f92672>+</span><span style=color:#ae81ff>5</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#39;/&#39;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>CurrentYear</span>)) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Deadline</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>FindNextWorkDay</span>(<span style=color:#a6e22e>DateValue</span>(<span style=color:#a6e22e>CurrentMonth</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#39;/5/&#39;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>CurrentYear</span>));
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Deadline</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>DateValue</span>(<span style=color:#a6e22e>CurrentMonth</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#39;/&#39;</span><span style=color:#f92672>+</span><span style=color:#ae81ff>5</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#39;/&#39;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>CurrentYear</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}	
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>Output deadline
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span> 
</span></span></code></pre></div><p>Now the corrected code.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span> <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>CurrentMonth</span>.<span style=color:#a6e22e>GetMonth</span>() <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;AUG&#34;</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Deadline</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>FindFourthWork</span>(<span style=color:#a6e22e>CurrentMonth</span>, <span style=color:#a6e22e>CurrentYear</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>FifthIsFriday</span>(<span style=color:#a6e22e>CurrentMonth</span>, <span style=color:#a6e22e>CurrentYear</span>)) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Deadline</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ThirdFriday</span>(<span style=color:#a6e22e>CurrentMonth</span>, <span style=color:#a6e22e>CurrentYear</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>IsHoliday</span>(<span style=color:#a6e22e>Deadline</span>)) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Deadline</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>FindNextWorkDay</span>(<span style=color:#a6e22e>Deadline</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>else</span> { <span style=color:#75715e>// Fifth is a friday
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>IsHoliday</span>(<span style=color:#a6e22e>DateValue</span>(<span style=color:#a6e22e>CurrentMonth</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#39;/&#39;</span><span style=color:#f92672>+</span><span style=color:#ae81ff>5</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#39;/&#39;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>CurrentYear</span>)) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Deadline</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>FindNextWorkDay</span>(<span style=color:#a6e22e>DateValue</span>(<span style=color:#a6e22e>CurrentMonth</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#39;/5/&#39;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>CurrentYear</span>));
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Deadline</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>DateValue</span>(<span style=color:#a6e22e>CurrentMonth</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#39;/&#39;</span><span style=color:#f92672>+</span><span style=color:#ae81ff>5</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#39;/&#39;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>CurrentYear</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}	
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>Output deadline
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span> 
</span></span></code></pre></div><p>As you can see both are very alike. The only difference between the two was the first checked weather Fifth was a work day and if it was it would try to schedule that as the deadline regardless of the month. However, the second code checked weather it was August first before doing FifthIsFriday.</p><p>The worst part of testing / writing a calendar related program specially one that deals non-deterministic time (this program could output the deadlines for 2030) is very difficult to write because date intrinsicly propose so many test cases. This bug was not caught for the past three years because the past three years none of the Augusts had fifth as friday. However this year, the 5th of August happened to be a friday and the program was computing incorrectly.</p><p>I then thought to myself how would I have caught this bug even before causing such a problem? And the only conclusion I could come to was EXTREMELY detailed requirements; but we <em>already knew</em> that!</p></div><h2>Comments</h2><script src=https://utteranc.es/client.js repo=splusq/splusq.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></main></body></html>