<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.120.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>Using the MVVM pattern on web applications – Part II &#183; Salman Quazi</title>
<meta name=description content><link type=text/css rel=stylesheet href=https://www.salmanq.com/css/print.css media=print><link type=text/css rel=stylesheet href=https://www.salmanq.com/css/poole.css><link type=text/css rel=stylesheet href=https://www.salmanq.com/css/syntax.css><link type=text/css rel=stylesheet href=https://www.salmanq.com/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png><style type=text/css>.sidebar-about h1{font-size:1.95rem;font-weight:400}</style><script async src="https://www.googletagmanager.com/gtag/js?id=G-K4WVH5P91F"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-K4WVH5P91F")</script></head><body class=theme-base-08><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://www.salmanq.com/><h1>Salman Quazi</h1></a><p class=lead>Director of Engineering for Microsoft Azure OpenAI in Mountain View, CA.</p></div><nav><ul class=sidebar-nav><li><a href=https://www.salmanq.com/>Home</a></li><li><a href=/blog/>Blog</a></li><li><a href=https://github.com/splusq/>Github</a></li><li><a href=https://www.linkedin.com/in/salmanquazi/>LinkedIn</a></li><li><a href=https://www.twitter.com/splusq>Twitter</a></li></ul></nav><p>Opinions are my own.</p></div></aside><main class="content container"><div class=post><h1>Using the MVVM pattern on web applications – Part II</h1><time datetime=2013-03-03T04:23:51Z class=post-date>Sun, Mar 3, 2013</time><p><a href=/blog/using-the-mvvm-pattern-on-web-applications-part-i/>Last time we looked at what the MVVM pattern was</a>, and how it is used today in XAML-based applications. Today we are going to take a step further and build a mechanism to use the MVVM pattern on traditional web applications. Imagine how powerful it would be if your UI could evolve independently. We are going to build a simple web application that will display top 5 &ldquo;memory intensive&rdquo; processes on the server side, and here&rsquo;s our basic architecture: <img src=/2013/03/mvvm-web-pattern.png alt="MVVM Architecture for Web Applications"></p><p>Recall, with MVVM we need the ability for our ViewModels to somehow send messages to the UI. In XAML that happened through Binding events. However, with web application the client and service are completely out-of-process so we need another mechanism to communicate. We use websocket to send messages to the client on the same transport that initiated the connection to the service in the first place. There are few subtleties, but let&rsquo;s get started we have a somewhat long road ahead, and we will talk about them along the way. Let&rsquo;s start with the most basic step, the model of our data.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProcessMetadata</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> Name { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> Memory { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> ProcessMetadata(<span style=color:#66d9ef>string</span> name, <span style=color:#66d9ef>string</span> memory)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.Name = name;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.Memory = memory;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>} 
</span></span></code></pre></div><p>Nothing special there - all we care about is the name of the process, and the memory it&rsquo;s currently consuming. Now, that we have the model we want to build our ViewModel (the core logic).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TaskViewModel</span> : BaseViewModel
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Timer timer;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> counter;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Process[] runningProcesses;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// a list of models (remember in MVVM the ViewModel &#34;knows&#34; about the Model)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> IList&lt;ProcessMetadata&gt; taskList;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> IList&lt;ProcessMetadata&gt; TaskList
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>get</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> taskList;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>set</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            RaiseAndSetProperty&lt;IList&lt;ProcessMetadata&gt;&gt;(<span style=color:#66d9ef>ref</span> taskList, <span style=color:#66d9ef>value</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> TaskViewModel()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        taskList = <span style=color:#66d9ef>new</span> List&lt;ProcessMetadata&gt;();
</span></span><span style=display:flex><span>        timer = <span style=color:#66d9ef>new</span> Timer(updateTasks, <span style=color:#66d9ef>null</span>, <span style=color:#ae81ff>2000</span>, <span style=color:#ae81ff>1000</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> updateTasks(Object state)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        runningProcesses = Process.GetProcesses();
</span></span><span style=display:flex><span>        TaskList = runningProcesses.
</span></span><span style=display:flex><span>            OrderByDescending(p =&gt; p.WorkingSet64).
</span></span><span style=display:flex><span>            ThenBy(p =&gt; p.ProcessName).
</span></span><span style=display:flex><span>            Select(p =&gt; <span style=color:#66d9ef>new</span> ProcessMetadata(
</span></span><span style=display:flex><span>                        p.ProcessName, String.Format(<span style=color:#e6db74>&#34;{0:n0} KB&#34;</span>, (p.WorkingSet64/<span style=color:#ae81ff>1024</span>)))).
</span></span><span style=display:flex><span>            Take(<span style=color:#ae81ff>5</span>).
</span></span><span style=display:flex><span>            ToList();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (++counter &gt;= <span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            timer.Change(Timeout.Infinite, Timeout.Infinite);
</span></span><span style=display:flex><span>            timer.Dispose();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>} 
</span></span></code></pre></div><p>The first thing to notice here with the ViewModel here is that there is nothing about the UI. We are dealing with normal variables, not UI elements. So what we are doing here is creating a timer, that runs every 2 seconds, and updates the TaskList property. That&rsquo;s it. In the setter of the TaskList we call a RaisePropertyChanged method. If you <a href=/blog/using-the-mvvm-pattern-on-web-applications-part-i/>recall in Part I</a>, we discussed the INotifyPropertyChanged interface - the standard approach to raising the PropertyChanged event is to implement a RaisePropertyChange method. And that&rsquo;s exactly what we have here. Nothing different from what you would do in a traditional XAML application. But the secret sauce is what the RaisePropertyChanged method does in this specific web application case:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BaseViewModel</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> RaiseAndSetProperty&lt;T&gt;(<span style=color:#66d9ef>ref</span> T field, T <span style=color:#66d9ef>value</span>, [CallerMemberName] <span style=color:#66d9ef>string</span> property = <span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (!field.Equals(<span style=color:#66d9ef>value</span>))
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            field = <span style=color:#66d9ef>value</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// At this point we need to do something special - since we are not in the XAML world</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>string</span> json;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>typeof</span>(T).IsValueType)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                json = <span style=color:#66d9ef>new</span> JObject() { <span style=color:#66d9ef>new</span> JProperty(property, <span style=color:#66d9ef>value</span>) }.ToString();
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                json = JObject.FromObject(<span style=color:#66d9ef>new</span> { Node = <span style=color:#66d9ef>value</span> }).ToString();
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// A simple websocket session manager that allows communication back to the client</span>
</span></span><span style=display:flex><span>            SessionManager.Current.SendToClient(json);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>} 
</span></span></code></pre></div><p>Okay the trick here is the JSON serialization and send back to the client via the Websocket. Quite simple really. We are also using the .NET 4.5 new CallerMemberName feature which automatically populates a parameter with the name of the member name that&rsquo;s calling this method - very useful in this case. So we are almost there. But we have one more missing piece on the server side. <a href=/blog/using-the-mvvm-pattern-on-web-applications-part-i/>Recall</a> in our last discussion we talked about a DataContext. The View creates the ViewModel and sets it as part of the DataContext. But in this case the view is a HTML - how can it create an instance of the ViewModel - which is on the server side? So we need to provide a really simple mechanism for this, and that&rsquo;s done via-exposing a MVC 4 Web API - REST endpoint:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AttachController</span> : ApiController
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>bool</span> Get(<span style=color:#66d9ef>string</span> id)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        Activator.CreateInstance(Type.GetType(id));
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>} 
</span></span></code></pre></div><p>That&rsquo;s it - all we are doing here is exposing a /attach/ API - where you can pass in the name of the ViewModel and it will use reflection to create an instance of that type for you on the server side. That&rsquo;s all. When the instance is created the rest of the communication happens through WebSockets like we saw earlier. We are very close to unwrapping this gift and this whole thing working end-to-end, but for that we will need the UI - which is a simple HTML page. We will discuss this in part III of our discussion.</p><ul><li><a href=/blog/using-the-mvvm-pattern-on-web-applications-part-i/>Using the MVVM pattern on web applications – Part I</a></li><li>Using the MVVM pattern on web applications – Part II</li><li><a href=/blog/using-the-mvvm-pattern-on-web-applications-part-iii/>Using the MVVM pattern on web applications – Part III</a></li></ul></div><h2>Comments</h2><script src=https://utteranc.es/client.js repo=splusq/splusq.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></main></body></html>