<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.120.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>ValueType Boxing &#183; Salman Quazi</title>
<meta name=description content><link type=text/css rel=stylesheet href=https://www.salmanq.com/css/print.css media=print><link type=text/css rel=stylesheet href=https://www.salmanq.com/css/poole.css><link type=text/css rel=stylesheet href=https://www.salmanq.com/css/syntax.css><link type=text/css rel=stylesheet href=https://www.salmanq.com/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png><style type=text/css>.sidebar-about h1{font-size:1.95rem;font-weight:400}</style><script async src="https://www.googletagmanager.com/gtag/js?id=G-K4WVH5P91F"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-K4WVH5P91F")</script></head><body class=theme-base-08><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://www.salmanq.com/><h1>Salman Quazi</h1></a><p class=lead>Engineering Manager for Microsoft Azure Cognitive Services in Mountain View, CA.</p></div><nav><ul class=sidebar-nav><li><a href=https://www.salmanq.com/>Home</a></li><li><a href=/blog/>Blog</a></li><li><a href=https://github.com/splusq/>Github</a></li><li><a href=https://www.linkedin.com/in/salmanquazi/>LinkedIn</a></li><li><a href=https://www.twitter.com/splusq>Twitter</a></li></ul></nav><p>Opinions are my own.</p></div></aside><main class="content container"><div class=post><h1>ValueType Boxing</h1><time datetime=2005-03-08T00:49:21Z class=post-date>Tue, Mar 8, 2005</time><p>In .NET an interesting phehomenon occurs known as &ldquo;boxing&rdquo;. Let me illustrate the problem and then we will look at the possible solutions:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>using</span> System;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> System.Collections;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Test</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>BankAccount</span> { <span style=color:#75715e>/* A simple BankAccount structure */</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>float</span> Balance; <span style=color:#75715e>/* Balance in the account */</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>public</span> BankAccount(<span style=color:#66d9ef>float</span> _Balance) { <span style=color:#75715e>/* overloaded-contructor */</span>
</span></span><span style=display:flex><span>			Balance = _Balance;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>/* A method to charge the account */</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> ChargeAccount(<span style=color:#66d9ef>float</span> Fee) { 
</span></span><span style=display:flex><span>			Balance-=Fee;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> Main() {
</span></span><span style=display:flex><span>		ArrayList Accounts = <span style=color:#66d9ef>new</span> ArrayList(); <span style=color:#75715e>/* An array */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		Accounts.Add(<span style=color:#66d9ef>new</span> BankAccount(<span style=color:#ae81ff>100</span>)); 
</span></span><span style=display:flex><span>		Accounts.Add(<span style=color:#66d9ef>new</span> BankAccount(<span style=color:#ae81ff>200</span>)); 	  
</span></span><span style=display:flex><span>		Accounts.Add(<span style=color:#66d9ef>new</span> BankAccount(<span style=color:#ae81ff>300</span>)); 	
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>/* Line: 21 */</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>/* Go through each account and ChargeAccount 5.0 */</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>foreach</span>(BankAccount Account <span style=color:#66d9ef>in</span> Accounts) {
</span></span><span style=display:flex><span>			Account.ChargeAccount((<span style=color:#66d9ef>float</span>)<span style=color:#ae81ff>5.0</span>);
</span></span><span style=display:flex><span>			Console.WriteLine(<span style=color:#e6db74>&#34;Boxed: &#34;</span> + Account.Balance);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>/* Go through each account and print the balance */</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>foreach</span>(BankAccount Account <span style=color:#66d9ef>in</span> Accounts) {
</span></span><span style=display:flex><span>			Console.WriteLine(<span style=color:#e6db74>&#34;Un-boxed: &#34;</span> + Account.Balance);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>} 
</span></span></code></pre></div><p>The program outputs the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Boxed: <span style=color:#ae81ff>95</span>
</span></span><span style=display:flex><span>Boxed: <span style=color:#ae81ff>195</span>
</span></span><span style=display:flex><span>Boxed: <span style=color:#ae81ff>295</span>
</span></span><span style=display:flex><span>Un-boxed: <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>Un-boxed: <span style=color:#ae81ff>200</span>
</span></span><span style=display:flex><span>Un-boxed: <span style=color:#ae81ff>300</span> 
</span></span></code></pre></div><p>Although you would most likely expect (or at least want) to get the following output:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Boxed: <span style=color:#ae81ff>95</span>
</span></span><span style=display:flex><span>Boxed: <span style=color:#ae81ff>195</span>
</span></span><span style=display:flex><span>Boxed: <span style=color:#ae81ff>295</span>
</span></span><span style=display:flex><span>Un-boxed: <span style=color:#ae81ff>95</span>
</span></span><span style=display:flex><span>Un-boxed: <span style=color:#ae81ff>195</span>
</span></span><span style=display:flex><span>Un-boxed: <span style=color:#ae81ff>295</span> 
</span></span></code></pre></div><p>So what happened? If you look at line 21, we assumed that Account was a reference copy to Accounts which it isn&rsquo;t. Account actually is a value-type (copied) value for each Accounts. And that&rsquo;s why when you do a Account.ChargeAccount the copied Account is charged and therefore you see the change only in the first foreach loop. In the second foreach loop you once again start referring to the original Accounts values which was 100,200,300 respectively.</p><p>To solve the problem you have to reference the actual object when doing ChargeAccount, something similar to this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>using</span> System;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> System.Collections;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Test</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>BankAccount</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>float</span> Balance;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>public</span> BankAccount(<span style=color:#66d9ef>float</span> _Balance) {
</span></span><span style=display:flex><span>			Balance = _Balance;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> ChargeAccount(<span style=color:#66d9ef>float</span> Fee) {
</span></span><span style=display:flex><span>			Balance-=Fee;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> Main() {
</span></span><span style=display:flex><span>		BankAccount[] Accounts = <span style=color:#66d9ef>new</span> BankAccount[<span style=color:#ae81ff>3</span>];
</span></span><span style=display:flex><span>		Accounts[<span style=color:#ae81ff>0</span>] = <span style=color:#66d9ef>new</span> BankAccount(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>		Accounts[<span style=color:#ae81ff>1</span>] = <span style=color:#66d9ef>new</span> BankAccount(<span style=color:#ae81ff>200</span>);
</span></span><span style=display:flex><span>		Accounts[<span style=color:#ae81ff>2</span>] = <span style=color:#66d9ef>new</span> BankAccount(<span style=color:#ae81ff>300</span>);
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>int</span> i=<span style=color:#ae81ff>0</span>;i&lt;accounts.Length;++i) {
</span></span><span style=display:flex><span>			Accounts[i].ChargeAccount((<span style=color:#66d9ef>float</span>)<span style=color:#ae81ff>5.0</span>);
</span></span><span style=display:flex><span>			Console.WriteLine(<span style=color:#e6db74>&#34;Boxed: &#34;</span> + Accounts[i].Balance);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>int</span> i=<span style=color:#ae81ff>0</span>;i&lt;accounts.Length;++i) {
</span></span><span style=display:flex><span>			Console.WriteLine(<span style=color:#e6db74>&#34;Un-Boxed: &#34;</span> + Accounts[i].Balance);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>} 
</span></span></code></pre></div><p>Notice however, this requires you to give a size of the array prior to using the array. This might be an inconvenience and there is a way to solve that problem also. We&rsquo;ll look into that next time.</p></div><h2>Comments</h2><script src=https://utteranc.es/client.js repo=splusq/splusq.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></main></body></html>